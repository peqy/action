name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build action
        run: npm run build

      - name: Verify dist is up-to-date
        run: |
          if [ -n "$(git status --porcelain dist)" ]; then
            echo "::error::dist/ folder is out of date. Please run 'npm run build' and commit the changes."
            git diff dist/
            exit 1
          fi
          echo "✓ dist/ folder is up-to-date"

      - name: Validate action.yml syntax
        run: |
          if ! command -v python3 &> /dev/null; then
            echo "Python3 not found, skipping YAML validation"
            exit 0
          fi
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "✓ action.yml syntax is valid"

      - name: Check required action.yml fields
        run: |
          for field in name description runs; do
            if ! grep -q "^${field}:" action.yml; then
              echo "::error::Missing required field: ${field}"
              exit 1
            fi
          done
          echo "✓ All required fields present in action.yml"

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration

  test-action:
    name: Test Action (if PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test action
        id: test
        uses: ./
        continue-on-error: true
        with:
          api-key: ${{ secrets.TEST_API_KEY || 'test-key-for-validation-only-at-least-32-chars-long' }}
          api-url: 'https://httpbin.org/post'
          fail-on-error: 'false'

      - name: Validate outputs exist
        run: |
          if [ -z "${{ steps.test.outputs.status-code }}" ]; then
            echo "::warning::status-code output is empty"
          else
            echo "✓ status-code output: ${{ steps.test.outputs.status-code }}"
          fi

          if [ -z "${{ steps.test.outputs.success }}" ]; then
            echo "::warning::success output is empty"
          else
            echo "✓ success output: ${{ steps.test.outputs.success }}"
          fi
