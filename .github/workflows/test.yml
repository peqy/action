name: Test Suite

on:
  workflow_dispatch:
    inputs:
      api-url:
        description: 'API URL to test against (leave empty for mock server)'
        required: false
        type: string
      test-type:
        description: 'Type of test to run'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - integration
          - mock-server
          - real-api
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || inputs.test-type == 'all' || inputs.test-type == 'integration'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: /tmp/test-*.log
          if-no-files-found: ignore

  mock-server-test:
    name: Mock Server Test
    runs-on: ubuntu-latest
    if: inputs.test-type == 'all' || inputs.test-type == 'mock-server'
    strategy:
      matrix:
        scenario: [success, created, unauthorized, serverError]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start mock server
        run: |
          SCENARIO=${{ matrix.scenario }} npm run test:mock-server > mock-server.log 2>&1 &
          echo $! > server.pid
          sleep 2

      - name: Test against mock server
        id: test
        continue-on-error: true
        run: |
          PEQY_API_URL="http://localhost:3000" \
          PEQY_API_KEY="test-api-key-at-least-32-characters-long" \
          npm test

      - name: Stop mock server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Show mock server logs
        if: always()
        run: |
          echo "=== Mock Server Logs ==="
          cat mock-server.log || echo "No logs found"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mock-server-logs-${{ matrix.scenario }}
          path: |
            mock-server.log
            /tmp/test-*.log
          if-no-files-found: ignore

  real-api-test:
    name: Test Against Real API
    runs-on: ubuntu-latest
    if: inputs.test-type == 'real-api' && inputs.api-url != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test against real API
        env:
          PEQY_API_URL: ${{ inputs.api-url }}
          PEQY_API_KEY: ${{ secrets.PEQY_API_KEY }}
        run: npm test

  test-pr-workflow:
    name: Test PR Workflow
    runs-on: ubuntu-latest
    if: inputs.test-type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create mock PR event
        run: |
          mkdir -p /tmp/github-event
          cat > /tmp/github-event/event.json << 'EOF'
          {
            "pull_request": {
              "number": 999,
              "head": {
                "sha": "abc123def456789012345678901234567890abcd"
              }
            },
            "repository": {
              "name": "test-repo",
              "owner": {
                "login": "test-owner"
              }
            }
          }
          EOF

      - name: Test action with PR context
        uses: ./
        with:
          api-key: test-key-for-validation-only-at-least-32-chars-long
          api-url: https://httpbin.org/post
          fail-on-error: false

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [integration-tests, mock-server-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "✅ Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.mock-server-test.result }}" == "success" ]; then
            echo "✅ Mock Server Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Mock Server Tests: ${{ needs.mock-server-test.result }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if tests failed
        if: needs.integration-tests.result == 'failure' || needs.mock-server-test.result == 'failure'
        run: exit 1
